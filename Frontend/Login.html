<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inicio de Sesión - Stellar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@500&display=swap" rel="stylesheet">
  <!-- Stellar SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/11.2.2/stellar-sdk.min.js"></script>
</head>
<body class="bg-gradient-to-r from-blue-400 to-blue-600 text-gray-800 min-h-screen flex items-center justify-center">
  
  <div class="max-w-md mx-auto p-10 bg-white rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6 font-Montserrat">Inicio de Sesión</h1>
    
    <!-- Estado de conexión de wallet -->
    <div id="walletStatus" class="mb-4 p-3 rounded-lg text-center hidden">
      <p id="walletAddress" class="text-sm font-mono"></p>
    </div>
    <!-- Estado de utilidades (oculto) -->
    
    <form id="loginForm" class="space-y-6">
      <div>
        <label for="username" class="block text-lg font-medium text-gray-700 font-Roboto">Nombre de usuario o correo</label>
        <input id="username" type="text" placeholder="Ingrese su nombre de usuario o correo" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required autocomplete="off" />
      </div>

      <div>
        <label for="loginPassword" class="block text-lg font-medium text-gray-700 font-Roboto">Contraseña</label>
        <input id="loginPassword" type="password" placeholder="Introduce tu contraseña" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" />
      </div>

      <!-- Sección para crear/cargar cuenta Stellar manual -->
      <div id="stellarAccountSection" class="mt-4 p-4 bg-blue-50 rounded-lg">
        <h3 class="text-base font-semibold mb-2">Cuenta Stellar Testnet</h3>
        <div class="flex flex-col gap-2">
          <button id="crearCuenta" type="button" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition">
            Crear y financiar cuenta
          </button>
          <label class="block">
            <span class="text-sm">Clave secreta de cuenta (S...):</span>
            <input type="text" id="claveSecretaManual" class="w-full border border-gray-300 p-2 rounded mt-1" placeholder="S..." />
          </label>
          <label class="block mt-2">
            <span class="text-sm">Clave pública de cuenta (G...):</span>
            <input type="text" id="clavePublicaManual" class="w-full border border-gray-300 p-2 rounded mt-1 bg-gray-100" placeholder="G..." readonly />
          </label>
          <button id="usarCuentaExistente" type="button" class="bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 transition">
            Usar cuenta existente
          </button>
          <div id="stellarAccountInfo" class="text-xs font-mono text-gray-700 whitespace-pre-wrap mt-2"></div>
        </div>
      </div>
      
      <div>
        <label class="block text-lg font-medium text-gray-700 font-Roboto">Cargar Imagen (Contraseña)</label>
        <div id="imageUpload" class="border-2 border-dashed border-blue-400 rounded-lg p-6 text-center cursor-pointer hover:bg-blue-50 transition duration-200">
          <p class="text-gray-600">Arrastra y suelta una imagen aquí o haz clic para seleccionar</p>
          <input type="file" accept="image/*" class="hidden" required />
        </div>
      </div>
      
      <div class="flex justify-between items-center mt-4">
        <a href="Register.html" class="text-blue-600 hover:underline">Crear nueva cuenta</a>
        <button type="submit" id="loginBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg transition transform hover:scale-105">
          Iniciar sesión
        </button>
      </div>
    </form>

    <!-- Sección de acciones del contrato -->
    <div id="contractActions" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-4">Acciones del Contrato</h3>
      <div class="grid grid-cols-2 gap-2">
        <button id="getUserBtn" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 transition">
          Obtener Usuario
        </button>
        <button id="editUserBtn" class="bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 transition">
          Editar Usuario
        </button>
        <button id="deleteUserBtn" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition">
          Eliminar Usuario
        </button>
        <button id="insertUserBtn" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition">
          Insertar Usuario
        </button>
      </div>
    </div>

    <div id="result" class="mt-6 text-sm font-mono text-gray-700 whitespace-pre-wrap p-3 bg-gray-100 rounded hidden"></div>
  </div>

  <script>
  // Variables del contrato
  const CONTRACT_ID = 'CDS3VGIAZFIZUG3GL6LWAXLOXWCRIIBDPPRS4225LLLEHPGTFDNF4PQK';
  // Usar Testnet público (coherente con friendbot y horizon-testnet)
  const RPC_URL = 'https://horizon-testnet.stellar.org';
  const SOROBAN_RPC_URL = 'https://rpc-testnet.stellar.org';
  // Limpieza automática inicial de usuarios de prueba (p. ej. 'monserrat')
  (function cleanTestUsersImmediate(){
    try {
      const raw = localStorage.getItem('users');
      if (!raw) return;
      const users = JSON.parse(raw);
      if (!Array.isArray(users) || users.length === 0) return;
      const filtered = users.filter(u => {
        if (!u || !u.username) return false;
        const name = String(u.username).trim().toLowerCase();
        // eliminar si contiene 'monserrat' o si el username está vacío
        if (name.length === 0) return false;
        if (name.includes('monserrat')) return false;
        return true;
      });
      if (filtered.length !== users.length) {
        // backup por si acaso
        try { localStorage.setItem('users_backup_' + Date.now(), raw); } catch(e){}
        localStorage.setItem('users', JSON.stringify(filtered));
        // si la clave pública corresponde a uno eliminado, borrarla para evitar mostrarla
        try { localStorage.removeItem('stellarPublic'); } catch(e){}
        console.log('Usuarios de prueba eliminados automáticamente.');
      }
    } catch (e) {
      console.warn('Error en limpieza automática de usuarios:', e);
    }
  })();
    
    // Variables globales
    let connectedWallet = null;
    let publicKey = null;

    // Variables para la cuenta Stellar manual
    let ultimaClavePublica = null;
    let ultimaClaveSecreta = null;
    let modoManual = false; // Si el usuario usa cuenta manual

    // Elementos del DOM
    const imageUploadDiv = document.getElementById('imageUpload');
    const fileInput = imageUploadDiv.querySelector('input[type="file"]');
    const walletStatus = document.getElementById('walletStatus');
    const walletAddress = document.getElementById('walletAddress');
    const loginBtn = document.getElementById('loginBtn');
    const loginForm = document.getElementById('loginForm');
    const contractActions = document.getElementById('contractActions');
    const result = document.getElementById('result');
    // Stellar manual
    const crearCuentaBtn = document.getElementById('crearCuenta');
    const usarCuentaExistenteBtn = document.getElementById('usarCuentaExistente');
    const claveSecretaManualInput = document.getElementById('claveSecretaManual');
    const clavePublicaManualInput = document.getElementById('clavePublicaManual');
    const stellarAccountInfo = document.getElementById('stellarAccountInfo');

    // Crear y financiar cuenta Stellar Testnet
    crearCuentaBtn.addEventListener('click', async () => {
      stellarAccountInfo.textContent = "Iniciando proceso de creación/financiación...";
      const StellarSdk = window.StellarSdk;
      if (!StellarSdk) {
        stellarAccountInfo.textContent = "No se pudo cargar StellarSdk.";
        return;
      }

      // Si Freighter está instalado, ofrecer usar la cuenta activa de Freighter (más práctico para que compras se registren en la wallet)
      if (typeof window.freighterApi !== 'undefined') {
        const usarFreighter = confirm('Se detectó Freighter. ¿Deseas financiar la cuenta actualmente seleccionada en Freighter (recomendado) en lugar de generar una nueva clave local)?');
        if (usarFreighter) {
          try {
            // Solicitar permisos si es necesario, y obtener la clave pública de Freighter
            try {
              const isAllowed = await window.freighterApi.isAllowed();
              if (!isAllowed) await window.freighterApi.setAllowed();
            } catch (permErr) {
              // intentar conectar si isAllowed no está disponible
              if (typeof window.freighterApi.connect === 'function') {
                await window.freighterApi.connect();
              }
            }

            const freighterPublic = await window.freighterApi.getPublicKey();
            stellarAccountInfo.textContent = `Cuenta Freighter detectada: ${freighterPublic}\nSolicitando fondos (friendbot) para esa cuenta...`;
            // Intentar financiar la cuenta Freighter en Testnet mediante friendbot
            const fbRes = await fetch(`https://friendbot.stellar.org?addr=${encodeURIComponent(freighterPublic)}`);
            const fbJson = await fbRes.json();
            stellarAccountInfo.textContent += `\n✅ Solicitud de friendbot enviada. Respuesta: ${JSON.stringify(fbJson)}`;

            // Actualizar estado y UI usando la cuenta de Freighter
            modoManual = false;
            connectedWallet = freighterPublic;
            publicKey = freighterPublic;
            walletAddress.textContent = `Cuenta Freighter: ${freighterPublic.substring(0,10)}...${freighterPublic.substring(freighterPublic.length - 10)}`;
            walletStatus.classList.remove('hidden');
            walletStatus.classList.add('bg-green-50', 'text-green-800');
            loginBtn.disabled = false;
            loginBtn.classList.remove('bg-gray-400');
            loginBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'hover:scale-105');
            return;
          } catch (err) {
            console.error('Error financiando cuenta Freighter:', err);
            stellarAccountInfo.textContent += `\n❌ Error al financiar la cuenta Freighter: ${err}`;
            // continuar al flujo de generación local si el usuario lo desea
            const fallback = confirm('No se pudo financiar la cuenta Freighter. ¿Deseas generar una clave nueva local en su lugar (deberás importarla manualmente en Freighter si quieres usarla allí)?');
            if (!fallback) return;
            // si fallback true, continue to generate new keypair below
          }
        }
      }

      // Flujo por defecto: generar un par de claves local y financiarlo con friendbot
      stellarAccountInfo.textContent = "Generando claves locales...";
      const pair = StellarSdk.Keypair.random();
      const publicKeyGen = pair.publicKey();
      const secretKey = pair.secret();
      ultimaClavePublica = publicKeyGen;
      ultimaClaveSecreta = secretKey;
      stellarAccountInfo.textContent = `Public Key: ${publicKeyGen}\nSecret Key: ${secretKey}\n\nFinanciando cuenta...`;
      try {
        const response = await fetch(`https://friendbot.stellar.org?addr=${encodeURIComponent(publicKeyGen)}`);
        const responseJSON = await response.json();
        stellarAccountInfo.textContent += `\n✅ Cuenta financiada\n${JSON.stringify(responseJSON, null, 2)}\n`;
        // Mostrar balance
        const server = new StellarSdk.Horizon.Server("https://horizon-testnet.stellar.org");
        const account = await server.loadAccount(publicKeyGen);
        stellarAccountInfo.textContent += `\n🔍 Balances:\n`;
        account.balances.forEach((balance) => {
          stellarAccountInfo.textContent += `Asset: ${balance.asset_type}, Balance: ${balance.balance}\n`;
        });
        // Activar modo manual y habilitar login
        modoManual = true;
        connectedWallet = publicKeyGen;
        publicKey = publicKeyGen;
        // Guardar clave secreta en localStorage para permitir compras sin pedir contraseña
        try {
          localStorage.setItem('stellarSecret', secretKey);
          localStorage.setItem('stellarPublic', publicKeyGen);
          console.log('Se guardó stellarSecret en localStorage para sesión local (recuerda limpiar si no lo deseas).');
        } catch(e) {
          console.warn('No se pudo guardar la clave secreta en localStorage:', e);
        }
        walletAddress.textContent = `Cuenta manual: ${publicKeyGen.substring(0, 10)}...${publicKeyGen.substring(publicKeyGen.length - 10)}`;
        walletStatus.classList.remove('hidden');
        walletStatus.classList.add('bg-yellow-100', 'text-yellow-800');
        loginBtn.disabled = false;
        loginBtn.classList.remove('bg-gray-400');
        loginBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'hover:scale-105');
        // Avisar al usuario cómo importar en Freighter si desea usar esa cuenta desde la extensión
        stellarAccountInfo.textContent += `\n\n⚠️ Nota: esta clave se generó localmente y no está en Freighter. Si deseas usarla desde Freighter, importa la clave secreta manualmente en la extensión.`;
      } catch (error) {
        stellarAccountInfo.textContent += `\n❌ Error al crear/fondear cuenta:\n${error}`;
      }
    });

    // (La limpieza de usuarios de prueba se hace automáticamente al iniciar el script.)

    // Usar cuenta existente with secret key
    usarCuentaExistenteBtn.addEventListener('click', async () => {
      const claveSecreta = claveSecretaManualInput.value.trim();
      stellarAccountInfo.textContent = "";
      const StellarSdk = window.StellarSdk;
      if (!claveSecreta.startsWith("S") || claveSecreta.length < 10) {
        stellarAccountInfo.textContent = "Clave secreta inválida.";
        return;
      }
      try {
        const pair = StellarSdk.Keypair.fromSecret(claveSecreta);
        ultimaClavePublica = pair.publicKey();
        clavePublicaManualInput.value = ultimaClavePublica;
        stellarAccountInfo.textContent = `Cuenta cargada:\nPublic Key: ${ultimaClavePublica}\nSecret Key: ${ultimaClaveSecreta}\n`;
        // Mostrar balance
        const server = new StellarSdk.Horizon.Server("https://horizon-testnet.stellar.org");
        const account = await server.loadAccount(ultimaClavePublica);
        stellarAccountInfo.textContent += `\n🔍 Balances:\n`;
        account.balances.forEach((balance) => {
          stellarAccountInfo.textContent += `Asset: ${balance.asset_type}, Balance: ${balance.balance}\n`;
        });
        // Activar modo manual y habilitar login
        modoManual = true;
        connectedWallet = ultimaClavePublica;
        publicKey = ultimaClavePublica;
        // Guardar secret en localStorage para evitar pedir contraseña al comprar
        try {
          localStorage.setItem('stellarSecret', claveSecreta);
          localStorage.setItem('stellarPublic', ultimaClavePublica);
        } catch(e) { console.warn('No se pudo guardar clave en localStorage', e); }
        walletAddress.textContent = `Cuenta manual: ${ultimaClavePublica.substring(0, 10)}...${ultimaClavePublica.substring(ultimaClavePublica.length - 10)}`;
        walletStatus.classList.remove('hidden');
        walletStatus.classList.add('bg-yellow-100', 'text-yellow-800');
        loginBtn.disabled = false;
        loginBtn.classList.remove('bg-gray-400');
        loginBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'hover:scale-105');
      } catch (error) {
        stellarAccountInfo.textContent = "Error al cargar la cuenta: " + error;
      }
    });

    // Función para mostrar resultados
    function showResult(message, type = 'info') {
      result.textContent = message;
      result.classList.remove('hidden');
      result.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
      if (type === 'success') {
        result.classList.add('bg-green-100', 'text-green-800');
      } else if (type === 'error') {
        result.classList.add('bg-red-100', 'text-red-800');
      } else {
        result.classList.add('bg-blue-100', 'text-blue-800');
      }
    }

    // Ejecutar acciones del contrato (simulado)
    async function ejecutarAccion(accion) {
      const username = document.getElementById('username').value.trim();
      if (!username) {
        alert('El nombre de usuario es obligatorio');
        return;
      }
      if (!connectedWallet) {
        alert('Por favor, conecta tu cuenta primero');
        return;
      }
      showResult(`Ejecutando acción: ${accion}...`, 'info');
      try {
        // Aquí integrarías con Soroban
        const simulatedResponse = {
          insert_user: `Usuario "${username}" insertado correctamente`,
          get_user: `Usuario encontrado: ${username}\nWallet: ${publicKey}`,
          edit_user: `Usuario "${username}" editado correctamente`,
          delete_user: `Usuario "${username}" eliminado correctamente`
        };
        await new Promise(resolve => setTimeout(resolve, 1500));
        showResult(`✓ ${simulatedResponse[accion]}`, 'success');
      } catch (error) {
        console.error('Error ejecutando acción:', error);
        showResult(`❌ Error: ${error.message}`, 'error');
      }
    }

    // Manejo de imagen
    imageUploadDiv.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        imageUploadDiv.querySelector('p').textContent = `✓ ${file.name}`;
        imageUploadDiv.classList.add('bg-green-50', 'border-green-400');
      }
    });
    imageUploadDiv.addEventListener('dragover', (event) => {
      event.preventDefault();
      imageUploadDiv.classList.add('bg-blue-100');
    });
    imageUploadDiv.addEventListener('dragleave', () => {
      imageUploadDiv.classList.remove('bg-blue-100');
    });
    imageUploadDiv.addEventListener('drop', (event) => {
      event.preventDefault();
      imageUploadDiv.classList.remove('bg-blue-100');
      const file = event.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        fileInput.files = event.dataTransfer.files;
        imageUploadDiv.querySelector('p').textContent = `✓ ${file.name}`;
        imageUploadDiv.classList.add('bg-green-50', 'border-green-400');
      }
    });

    // Formulario de login
    loginForm.addEventListener('submit', function(event) {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const imageFile = fileInput.files[0];
      if (!imageFile) {
        alert('Por favor, carga una imagen.');
        return;
      }
      if (!connectedWallet) {
        alert('Por favor, crea o carga una cuenta primero.');
        return;
      }
  // Guarda solo la clave pública en localStorage; la clave secreta no se guarda en claro
  if (ultimaClavePublica) localStorage.setItem('stellarPublic', ultimaClavePublica);

      showResult(`✓ Conexión exitosa para ${username}\nCuenta: ${connectedWallet}`, 'success');
      setTimeout(() => {
        window.location.href = "inicio.html";
      }, 1000);
    });

    // Botones de acciones del contrato
    document.getElementById('getUserBtn').addEventListener('click', () => ejecutarAccion('get_user'));
    document.getElementById('editUserBtn').addEventListener('click', () => ejecutarAccion('edit_user'));
    document.getElementById('deleteUserBtn').addEventListener('click', () => ejecutarAccion('delete_user'));
    document.getElementById('insertUserBtn').addEventListener('click', () => ejecutarAccion('insert_user'));

    // Al cargar la página, intentar conectar con la cuenta Stellar si las claves están en localStorage
    window.addEventListener('load', () => {
      const publicKeyStored = localStorage.getItem('stellarPublic');
      if (publicKeyStored) {
        // Mostramos la clave pública almacenada pero la clave secreta está cifrada por usuario y no se carga automáticamente.
        walletStatus.classList.remove('hidden');
        walletStatus.classList.add('bg-blue-50', 'text-blue-800');
        walletAddress.textContent = `Cuenta pública (protegida): ${publicKeyStored.substring(0,10)}...${publicKeyStored.substring(publicKeyStored.length - 10)}`;
      } else {
        // no mostrar alert, solo indicar que no hay wallet conectada
        walletStatus.classList.remove('hidden');
        walletStatus.classList.add('bg-blue-50', 'text-blue-800');
        walletAddress.textContent = 'No hay cuenta Stellar conectada.';
      }
      // No poblamos selector: el flujo ahora exige registro manual en Register.html.

      // Limpieza automática de usuarios de prueba (por ejemplo "monserrat").
      try {
        const users = loadUsers();
        const filtered = users.filter(u => {
          if (!u || !u.username) return true;
          return u.username.toLowerCase().indexOf('monserrat') === -1;
        });
        if (filtered.length !== users.length) {
          localStorage.setItem('users', JSON.stringify(filtered));
          showResult('Se eliminaron usuarios de prueba encontrados (p. ej. "monserrat").', 'info');
        }
      } catch (e) {
        console.warn('Error limpiando usuarios de prueba:', e);
      }
    });

    // --- Gestión de usuarios (registro/login) usando localStorage y SHA-256 ---
    function buf2hex(buffer) {
      return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
    }
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return buf2hex(hash);
    }
    // --- Funciones para descifrar la clave secreta cifrada en Register ---
    function b64ToArrayBuffer(b64) {
      const binary = atob(b64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
      return bytes.buffer;
    }
    async function deriveKey(password, saltB64, iterations = 100000) {
      const saltBuf = b64ToArrayBuffer(saltB64);
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), {name: 'PBKDF2'}, false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        {name: 'PBKDF2', salt: saltBuf, iterations: iterations, hash: 'SHA-256'},
        keyMaterial,
        {name: 'AES-GCM', length: 256},
        false,
        ['encrypt','decrypt']
      );
    }
    async function decryptSecret(encryptedB64, saltB64, ivB64, password) {
      try {
        const key = await deriveKey(password, saltB64);
        const iv = new Uint8Array(b64ToArrayBuffer(ivB64));
        const cipherBuf = b64ToArrayBuffer(encryptedB64);
        const plainBuf = await crypto.subtle.decrypt({name: 'AES-GCM', iv: iv}, key, cipherBuf);
        const dec = new TextDecoder();
        return dec.decode(plainBuf);
      } catch (e) {
        throw new Error('No se pudo descifrar la clave secreta con la contraseña proporcionada.');
      }
    }
    function loadUsers() {
      try { return JSON.parse(localStorage.getItem('users') || '[]'); } catch (e) { return []; }
    }

    // Modificar el submit del login para validar usuario y contraseña (usar campo de contraseña en lugar de prompt)
    loginForm.removeEventListener && loginForm.removeEventListener('submit', ()=>{});
    loginForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      const usernameOrEmail = document.getElementById('username').value.trim();
      const passwordInput = document.getElementById('loginPassword').value;
      const imageFile = fileInput.files[0];

      const users = loadUsers();
      // Validar siempre credenciales contra usuarios registrados
      if (!passwordInput) {
        alert('Contraseña requerida para iniciar sesión.');
        return;
      }
      const hashed = await hashPassword(passwordInput);
      const found = users.find(u => (u.username === usernameOrEmail || u.email === usernameOrEmail) && u.passwordHash === hashed);
      if (!found) {
        alert('Usuario no encontrado o contraseña incorrecta. Por favor, regístrate primero. Serás redirigido al formulario de registro.');
        window.location.href = 'Register.html';
        return;
      }

      // Si el usuario tiene clave secreta cifrada, intentar descifrar con la contraseña
      if (found.encryptedSecret && found.encSalt && found.encIv) {
        try {
          const secret = await decryptSecret(found.encryptedSecret, found.encSalt, found.encIv, passwordInput);
          ultimaClaveSecreta = secret;
          ultimaClavePublica = found.stellarPublic || null;
          modoManual = true;
          connectedWallet = ultimaClavePublica;
          publicKey = ultimaClavePublica;
          // Actualizar UI
          try {
            walletAddress.textContent = `Cuenta manual: ${ultimaClavePublica.substring(0,10)}...${ultimaClavePublica.substring(ultimaClavePublica.length-10)}`;
            walletStatus.classList.remove('hidden');
            walletStatus.classList.add('bg-yellow-100', 'text-yellow-800');
          } catch(e){}
        } catch (decErr) {
          alert(decErr.message);
          return;
        }
      }

      // Verificar que haya wallet conectado o claves manuales
      if (!connectedWallet && !ultimaClavePublica) {
        const ok = confirm('No hay cuenta Stellar conectada. ¿Deseas continuar sin wallet?');
        if (!ok) return;
      }

  // Guarda solo la clave pública en localStorage; la clave secreta queda cifrada por el usuario y no se almacena en claro
  if (ultimaClavePublica) localStorage.setItem('stellarPublic', ultimaClavePublica);

      showResult(`✓ Autenticación exitosa para ${usernameOrEmail}\nCuenta: ${connectedWallet || ultimaClavePublica || 'N/A'}`, 'success');
      setTimeout(() => { window.location.href = "inicio.html"; }, 1000);
    });
  </script>
</body>
</html>